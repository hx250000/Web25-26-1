<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Game</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #f5efe6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
            font-family: sans-serif;
        }

        .container {
            background-color: #fff;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            width: 100%;
            overflow: hidden;
            position: relative;

        }

        .screen {
            display: none;
            padding: 2rem;
            text-align: center;

        }

        .screen.active {
            display: block;

        }

        #start-screen h1 {
            color: #e86a53;
            margin-bottom: 20px;
            font-size: 2.5rem;
        }

        #start-screen p {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        button {
            background-color: #e86a53;
            color: #fff;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #d45b28;
        }

        .quiz-header {
            margin-bottom: 1rem;
        }

        #question-text {
            color: #333;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .quiz-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: #666;
        }

        .answers-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        /* Answer Buttons to be added in js */
        .progress-bar {
            background-color: #f8f0e5;
            border-radius: 5px;
            overflow: hidden;
            height: 10px;
            margin-top: 20px;
        }

        .progress {
            background-color: #e86a53;
            height: 100%;
            width: 0%;
            transition: width 0.3s;
        }

        #result-screen h1 {
            color: #e86a53;
            margin-bottom: 30px;
            font-size: 2rem;
        }

        .result-info {
            background-color: #f8f0e5;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .result-info p {
            color: #333;
            font-size: 1.2rem;
            margin-bottom: 1rem;
        }

        .result-message {
            font-size: 1.5rem;
            font-weight: 600;
            color: #e86a53;
        }

        .logout-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #e86a53;
            color: #fff;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            z-index: 1000;
            transition: background-color 0.3s;
        }

        .logout-btn:hover {
            background-color: #d45b28;
        }


        @media(max-width:500px) {
            .screen {
                padding: 1rem;
            }

            #start-screen h1 {
                font-size: 2rem;
            }

            #question-text {
                font-size: 1.3rem;
            }

            .answer-btn {
                padding: 12px;
            }

            button {
                padding: 12px 25px;
                font-size: 1rem;
            }
        }
    </style>
</head>

<body>
    <button id="logout-btn" class="logout-btn">退出登录</button>
    <div class="container">
        <div class="screen active" id="start-screen">
            <h1>Quiz Time!</h1>
            <p>Test your knowledge with these questions!</p>
            <button id="start-btn">Start Quiz</button>
        </div>
        <div class="screen" id="quiz-screen">
            <div class="quiz-header">
                <h2 id="question-text">Question goes here</h2>
                <div class="quiz-info">
                    <p>
                        Question <span id="current-question"> 1</span> of <span id="total-questions">5</span>
                    </p>
                    <p>
                        Score: <span id="score">0</span>
                    </p>
                </div>
                <div class="answers-container" id="answers-container">
                    <!-- Answer buttons will be generated here -->
                    ans1
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress" id="progress"></div>
            </div>
        </div>
        <div class="screen" id="result-screen">
            <h1>Quiz Result!</h1>
            <div class="result-info">
                <p>You scored <span id="final-score"> 0</span> out of <span id="max-score">5</span></p>
                <div class="result-message" id="result-message"> </div>
            </div>

            <button id="restart-btn">Restart Quiz</button>
        </div>

    </div>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // DOM Elements
        const startScreen = document.getElementById("start-screen");
        const quizScreen = document.getElementById("quiz-screen");
        const resultScreen = document.getElementById("result-screen");
        const startButton = document.getElementById("start-btn");
        const questionText = document.getElementById("question-text");
        const answersContainer = document.getElementById("answers-container");
        const currentQuestionSpan = document.getElementById("current-question");
        const totalQuestionsSpan = document.getElementById("total-questions");
        const scoreSpan = document.getElementById("score");
        const finalScoreSpan = document.getElementById("final-score");
        const maxScoreSpan = document.getElementById("max-score");
        const resultMessage = document.getElementById("result-message");
        const restartButton = document.getElementById("restart-btn");
        const progressBar = document.getElementById("progress");

        // quizQuestions will be loaded from backend
        let quizQuestions = [];

        // QUIZ STATE VARS
        let currentQuestionIndex = 0;
        let score = 0;
        let answersDisabled = false;


        // NOTE: total/max will be set after we fetch questions from backend

        // 点击 Start 时先从后端拉取题目（带 token），再开始
        // JWT 拦截器：自动在请求中添加 token，401/403 时跳转登录
        axios.interceptors.request.use(function (config) {
            const token = localStorage.getItem('token');
            if (token) {
                config.headers.Authorization = 'Bearer ' + token;
                config.headers.token = token;
            }
            return config;
        }, function (error) {
            return Promise.reject(error);
        });

        // 响应拦截器：JWT 验证失败时自动跳转登录
        let isRedirecting = false; // 防止多次重定向
        axios.interceptors.response.use(function (response) {
            return response;
        }, function (error) {
            if (!isRedirecting && error.response && (error.response.status === 401 || error.response.status === 403)) {
                isRedirecting = true;
                localStorage.removeItem('token');
                localStorage.removeItem('userId');
                localStorage.removeItem('username');
                window.location.href = 'login.html';
            }
            return Promise.reject(error);
        });

        startButton.addEventListener("click", fetchQuestionsAndStart);

        function fetchQuestionsAndStart() {
            const token = localStorage.getItem('token');
            if (!token) {
                localStorage.removeItem('token');
                window.location.href = 'login.html';
                return;
            }

            axios.get('http://localhost/usergetquestions', {
                headers: { token: token },
                withCredentials: true
            })
                .then(function (response) {
                    const res = response.data || {};
                    if (res.code === 200 && Array.isArray(res.data)) {
                        quizQuestions = res.data;
                        totalQuestionsSpan.textContent = quizQuestions.length;
                        maxScoreSpan.textContent = quizQuestions.length;
                        startQuiz();
                    } else {
                        alert(res.msg || '获取题目失败');
                    }
                })
                .catch(function (error) {
                    console.error('请求题目失败：', error);
                    // JWT 验证失败会在拦截器中自动跳转，不需要再显示警告
                    if (!error.response || (error.response.status !== 401 && error.response.status !== 403)) {
                        alert('请求题目失败，请稍后重试');
                    }
                });
        }

        function startQuiz() {
            // reset vars
            currentQuestionIndex = 0;
            score = 0;
            scoreSpan.textContent = 0;

            startScreen.classList.remove("active");
            quizScreen.classList.add("active");

            showQuestion();
        }

        function showQuestion() {
            // reset state
            answersDisabled = false;
            const currentQuestion = quizQuestions[currentQuestionIndex];
            currentQuestionSpan.textContent = currentQuestionIndex + 1;

            const progressPercent = (currentQuestionIndex / quizQuestions.length) * 100;
            progressBar.style.width = progressPercent + "%";
            questionText.textContent = currentQuestion.question;
            answersContainer.innerHTML = "";

            currentQuestion.answers.forEach((answer) => {
                const button = document.createElement("button");
                button.textContent = answer.text;
                button.classList.add("answer-btn");

                // what is dataset? it's a property of the button element that allows you to store custom data
                button.dataset.correct = answer.correct;
                button.addEventListener("click", selectAnswer);
                answersContainer.appendChild(button);
            });
        }

        function selectAnswer(event) {
            // optimization check
            if (answersDisabled) return;
            answersDisabled = true;

            const selectedButton = event.target;
            const isCorrect = selectedButton.dataset.correct === "true";
            // Here Array.from() is used to convert the NodeList returned by answersContainer.children into an array, this is because the NodeList is not an array and we need to use the forEach method
            Array.from(answersContainer.children).forEach((button) => {
                if (button.dataset.correct === "true") {
                    button.classList.add("correct");
                } else if (button === selectedButton) {
                    button.classList.add("incorrect");
                }
            });

            if (isCorrect) {
                score++;
                scoreSpan.textContent = score;
            }

            setTimeout(() => {
                currentQuestionIndex++;
                // check if there are more questions or if the quiz is over
                if (currentQuestionIndex < quizQuestions.length) {
                    showQuestion();
                } else {
                    showResults();
                }
            }, 1000);
        }

        function showResults() {
            quizScreen.classList.remove("active");
            resultScreen.classList.add("active");

            finalScoreSpan.textContent = score;

            const percentage = (score / quizQuestions.length) * 100;

            if (percentage === 100) {
                resultMessage.textContent = "Perfect! You're a genius!";
            } else if (percentage >= 80) {
                resultMessage.textContent = "Great job! You know your stuff!";
            } else if (percentage >= 60) {
                resultMessage.textContent = "Good effort! Keep learning!";
            } else if (percentage >= 40) {
                resultMessage.textContent = "Not bad! Try again to improve!";
            } else {
                resultMessage.textContent = "Keep studying! You'll get better!";
            }
        }

        restartButton.addEventListener("click", restartQuiz);

        function restartQuiz() {
            resultScreen.classList.remove("active");
            startQuiz();
        }
        document.getElementById("logout-btn").addEventListener("click", function () {
            localStorage.removeItem('token');
            localStorage.removeItem('userId');
            localStorage.removeItem('username');
            window.location.href = 'login.html';
        });

    </script>
</body>

</html>